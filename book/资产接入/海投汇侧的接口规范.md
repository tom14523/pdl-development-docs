# 海投汇侧的接口规范

## 调用环境入口

* 测试：http://new-uat.test.htouhui.com/openapi/
* 预发：https://stage.htouhui.com/openapi/
* 生产：https://www.htouhui.com/openapi/

## HTTP请求与响应

* API接口的 `HTTP METHOD` 在具体接口中定义，一般查询操作会用 `GET`，修改操作会用 `POST`。
* 所有的API请求和响应数据编码皆为`UTF-8`格式（切勿转成`unicode`编码），对于含有中文字符的消息报文，URL 里的参数值在发送请求时需要`URLEncoder`，接收请求时需做`URLDecoder`处理。
* `POST` 请求的参数，需要以 `application/x-www-form-urlencoded` 的方式提交数据，也就是浏览器原生的 `<form>` 表单发送的数据格式。

## 调用参数

调用API时，必须传入`公共参数`和具体某个API的`API参数`，各个API的输入参数和返回结果，详见API文档。

### 1. 公共参数
  
| 字段名    | 字段描述     | 类型   | 最大长度 | 必填 | 备注                                                                                               |
| --------- | ------------ | ------ | -------- | ---- | -------------------------------------------------------------------------------------------------- |
| version   | 接口版本号   | String | 5        | 是   | 目前为1.0                                                                                          |
| app_id    | 应用的app_id | String | 8        | 是   |                                                                                                    |
| timestamp | 时间戳       | String | 19       | 是   | 格式为yyyy-MM-dd HH:mm:ss，例如：2011-06-16 13:23:30。海投汇API服务端允许客户端请求时间误差为6分钟 |
| sign      | 签名         | String |          | 是   |                                                                                                    |

### 2. API参数

| 字段名    | 字段描述     | 类型   | 最大长度 | 必填 | 备注                                                                                               |
| --------- | ------------ | ------ | -------- | ---- | -------------------------------------------------------------------------------------------------- |
| param      | API参数      | String |          | 是   | Json String                                                                                         |

### 3. API参数的拼装

以`提现API`为例:

| 字段名              | 字段描述             | 类型   | 最大长度 | 必填 | 备注                                    |
|---------------------|----------------------|--------|----------|------|-----------------------------------------|
| third_party_user_id | 商户用户id           | String | 50       | 是   | 全局唯一                                |
| money               | 提现金额             | String | 16       | 是 |                                         |
| return_url          | 返回页面链接         | String | 256      | 是 | Get方式跳转                             |
| notify_url          | 后台通知链接         | String | 200      | 是 | 结果通知会post到此url                   |
| from_url            | 商户用户操作提现页面 | String | 256      | 是 | 用户提现操作重置交易密码后返回的页面url |

拼装后的示例:

| 字段名              | 字段描述             | 类型   | 示例值                                    |
|---------------------|----------------------|--------|-----------------------------------------|
| param              | API参数              | String | {"third_party_user_id":"123456789","money":"20.50","return_url":"http://xxx/xxx","notify_url":"http://xxx/yyy","from_url":"http://xxx/zzz"}  |

## 响应结果

接口的响应结果以 `Json` 格式返回，包含 `公共参数` 和具体某个API的`API返回数据`

### 1. 公共参数

| 字段名      | 字段描述     | 类型   | 最大长度 | 必填 | 备注                                                                                            |
|-------------|--------------|--------|----------|------|-------------------------------------------------------------------------------------------------|
| version     | 接口版本号   | String | 5        | 是   | 目前为1.0                                                                                       |
| app_id      | 应用的app_id | String | 8        | 是   |                                                                                                 |
| timestamp   | 时间戳       | String | 19       | 是   | 格式为yyyy-MM-dd HH:mm:ss，例如：2011-06-16 13:23:30。海投汇API服务端允许客户端请求时间误差为6分钟 |
| ret_code    | 响应状态码    | int |          | 是   |                                                                                                 |
| ret_message | 响应描述     | String |          | 是   |                                                                                                 |
| sign        | 签名         | String |          | 是   |                                                                                                 |

### 2. API返回数据

| 字段名    | 字段描述     | 类型   | 最大长度 | 必填 | 备注                                                                                               |
| --------- | ------------ | ------ | -------- | ---- | -------------------------------------------------------------------------------------------------- |
| data      | 响应数据      |String |     | 是  | Json String           |

### 3. 响应结果示例

```json
{
    "version":"1.0",
    "app_id":"abcdefg",
    "timestamp":"2011-06-16 13:23:30",
    "ret_code":20000,
    "ret_message":"OK",
    "data":"{\"xxx\":\"yyy\"}",
    "sign":"a81d1b14a50d9576e41eb19cda7502570eaf6f0e"
}
```

### 4. 响应结果的签名计算方式，与调用参数的签名方式相同

## API参数签名

调用API时，需要对请求参数进行签名，海投汇服务器会验证请求参数是否合法。

### 签名生成规则

#### 特别注意以下重要规则：

* 参数名ASCII码从小到大排序（字典序）；
* 如果参数的值为 `null`，则不参与签名，但是空字符串要参与签名；
* 参数名区分大小写；
* 海投汇主动发起通知时，传送的sign参数不参与签名，需要接收方自己将接收到的参数生成签名，然后与该sign值作校验；
* 接口可能增加字段，验证签名时必须支持增加的扩展字段；

#### 签名生成步骤

1. 所有请求参数按照参数名ASCII码从小到大排序（字典序）。

    例如：将version,app_id,timestamp,param 排序为 app_id,param,timestamp,version

2. 把所有参数名和参数值使用URL键值对的格式（即key1=value1&key2=value2…）拼接成字符串 `stringA`

    例如：

    ```java
    stringA = "app_id=xxx&param={\"xxx\":\"yyy\"}&timestamp=2011-06-16 13:23:30&version=1.0";
    ```

3. 把签名密钥 `key` 拼在字符串 `stringA` 的后面，得到 `stringSignTemp` 字符串，`key` 不参与前面的参数排序

    例如：

    ```java
    stringSignTemp = stringA + "&key=192006250b4c09247ec02edce69f6a2d";  //注：key为商户设置的密钥key
    ```

4. 使用 `SHA1` 加密，再转换成大写字母

    例如：

    ```java
    sign = SHA1(stringSignTemp).toUpperCase();
    ```

## 签名示例代码

Java 示例

| 函数         | 作用                             |
|--------------|----------------------------------|
| concatParams | 将输入参数排序并拼接             |
| getSign      | 通过给定的`param`和`key`计算签名 |

```java
import org.apache.commons.codec.digest.DigestUtils;

import java.util.Arrays;
import java.util.Map;

public class HtouhuiSignUtils {

    public static final String PARAMETER_DIGEST = "sign";

    /**
     * 处理请求参数。0.去掉摘要参数, 1.按照参数名称排序，2.拼接参数为name1=value1&name2=value2的形式
     *
     * @param parameterMap 请求参数
     * @return 返回拼接好的参数字符串
     */
    public static String concatParams(Map<String, String[]> parameterMap) {
        return parameterMap.entrySet().stream()
                .filter(entry -> !entry.getKey().equals(PARAMETER_DIGEST) && entry.getValue() != null)
                .sorted(Comparator.comparing(Map.Entry::getKey))
                .map(entry -> entry.getKey() + "=" + Arrays.stream(entry.getValue()).sorted(String::compareTo).collect(Collectors.joining()))
                .collect(Collectors.joining("&"));
    }

    /**
     * 通过给定的`param`和`key`计算签名
     *
     * @param parameterMap 请求参数，来自 {@link javax.servlet.http.HttpServletRequest#getParameterMap()}
     * @param key          商户设置的密钥key
     * @return 参数签名
     */
    public static String getSign(Map<String, String[]> param, String key) {
        StringBuilder resultStr = new StringBuilder();
        resultStr.append(concatParams(param)).append("&key=").append(key);
        return DigestUtils.sha1hex(resultStr.toString()).toUpperCase();
    }

}
```